<html>
<body>
<button type="button" onclick="logout();">退出登录</button></br>
操作数A: <input type="number" id="num1" /> </br>
操作数B: <input type="number" id="num2" /> </br>
<button type="button" onclick="addpost();"> 求和post </button>
<button type="button" onclick="addget();"> 求和get </button>
<p id="result"> </p></br>
<hr>
<p id="wsStatus">websocket未连接</p>
<button type="button" name="cmdSendMsg" onclick="SendMsg();"> 发送 </button>
<input type="text" id="sendmsg" /></br>
接收到消息:<p id="wsRecv"> </p></br>
<hr>

<input type="file" id="selector" accept="image/jpeg,image/png" /></br>
<div id="status">No uploads</div></br>
<button type="button" onclick="upload();"> 上传 </button>
<button type="button" onclick="download();"> 下载 </button>
<img src="" id="photo" width="200px" alt="用户头像" />
<!-- 内嵌的javascript代码 -->
<script>

	async function upload() {
		// 获取输入框内的值
		var file = document.getElementById('selector').files[0];
		if (!file) {
            console.log("请选择文件...");
		    return
        }

        console.log(file);

        var fileSuffix = file.name.split('.').pop().toLowerCase();
        const data = {
            cmd: 0,
            type: "photo",
            Suffix: fileSuffix
        };

		// 从服务器获取一个URL
		var url = await retrieveNewURL(data);
		// 将文件上传到url
        uploadFile(file, url);
	}

    async function download() {
        // 获取输入框内的值
        var photo = document.getElementById('photo');

        const data = {
            cmd: 1,
            type: "photo",
            Suffix: "jpg"
        };

        // 从服务器获取一个URL
        var url = await retrieveNewURL(data);
        // 显示
        photo.src = url;
    }

    async function retrieveNewURL(data) {

		const url = '/api/presignedUrl';
		const options = {
		    headers: {
		        "content-type": "application/json; charset=UTF-8",
		        "Username":localStorage.getItem("Username"),
		        "Token": localStorage.getItem("Token")
		    },
            // 将请求javascript object转换为JSON字符串
            body: JSON.stringify(data),
		    method: "POST"
		}
		// 发出http post请求,等待响应
		let response = await fetch(url, options)
		
		// 将响应作为JSON字符串反序列化为javascript object
		let rspjson = await response.json()
		console.log(rspjson)

        return rspjson.result;
    }

    async function uploadFile(file, url) {
        if (document.querySelector('#status').innerText === 'No uploads') {
            document.querySelector('#status').innerHTML = '';
        }

        await fetch(url, {
            method: 'PUT',
            body: file
        }).then(() => {
            // If multiple files are uploaded, append upload status on the next line.
            document.querySelector('#status').innerHTML += `<br>上传成功: ${file.name}`;
        }).catch((e) => {
            console.error(e);
        });
    }


    // 计算按钮的点击响应函数
    async function logout() {

        const url = '/api/logout';
        const options = {
            headers: {
                "content-type": "application/json; charset=UTF-8",
                "Username":localStorage.getItem("Username"),
                "Token": localStorage.getItem("Token")
            },
            method: "POST"
        }

        // 发出http post请求, 等待响应
        let rsp = await fetch(url, options)

        localStorage.setItem("Token", "");
        localStorage.setItem("Username", "");
        window.location.href = "login.html";

    }

    // 计算按钮的点击响应函数
    async function addpost() {
        // 获取输入框内的值
        var num1 = document.getElementById('num1').value;
        var num2 = document.getElementById('num2').value;
        const url = '/api/addpost';
        const data = {
            OperandA: (Number)(num1),
            OperandB: (Number)(num2)
        };
        console.log(data)
        console.log(localStorage.getItem("Token"))
        const options = {
            headers: {
                "content-type": "application/json; charset=UTF-8",
                "Username":localStorage.getItem("Username"),
                "Token": localStorage.getItem("Token")
            },
            // 将请求javascript object转换为JSON字符串
            body: JSON.stringify(data),
            method: "POST"
        }
        // 发出http post请求
        let response = await fetch(url, options)

        // 等待响应，并将响应作为JSON字符串反序列化为javascript object
        let rspjson = await response.json()
        console.log(rspjson)

        if (0 == rspjson.status) {
            // 使用结果来更新对应元素的内容
            document.getElementById('result').innerText = rspjson.result
        } else {
            alert(rspjson.message + "\n即将重新登录!");
            window.location.href = "login.html";
        }

    }

    async function addget() {
        // 获取输入框内的值
        var num1 = document.getElementById('num1').value;
        var num2 = document.getElementById('num2').value;
        const url = '/api/addget?OperandA=' + num1 + '&OperandB=' + num2;

        console.log(url)
        const options = {
            headers: {
                "content-type": "application/json; charset=UTF-8",
                "Username":localStorage.getItem("Username"),
                "Token": localStorage.getItem("Token")
            },
            method: "GET"
        }
        // 发出http post请求
        let response = await fetch(url, options)

        // 等待响应，并将响应作为JSON字符串反序列化为javascript object
        let rspjson = await response.json()
        console.log(rspjson)

        if (0 == rspjson.status) {
            // 使用结果来更新对应元素的内容
            document.getElementById('result').innerText = rspjson.result
        } else {
            alert(rspjson.message + "\n即将重新登录!");
            window.location.href = "login.html";
        }
    }

    var ws = null;
    window.onload = function() {
        var domain = document.domain; //获取主机名        例如：172.20.11.111
        var port = location.port; //获取端口号        例如：8000
        var host = location.host; //获取主机名:端口号 例如：172.20.11.111:8000

        ws = new WebSocket("ws://" + host + "/api/echo");
        ws.onopen = function() {
            // Web Socket 已连接 ws.readyState = 1
            document.getElementById('wsStatus').innerText = "websocket已连接";

            ws.onmessage = function(evt) {
                document.getElementById('wsRecv').innerText += evt.data + "\n";
            };

            ws.onclose = function(evt) {
                // Web Socket 已断开 ws.readyState = 3
                document.getElementById('wsStatus').innerText = "websocket已断开";
            };
        }
    }

    function SendMsg() {
        if (1 == ws.readyState) {
            ws.send(document.getElementById('sendmsg').value);
        }
    }
</script>

</body>
</html>
