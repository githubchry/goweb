<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Hello</title>
</head>
<body>

<button onclick="window.location.href = '/';" class="mui-btn mui-btn-block mui-btn-primary">返回主页</button></br>
<img src="{{.Photo}}" id="photo" width="200px" alt="用户头像" />
</br>
<input type="file" id="selector" accept="image/jpeg,image/png" />
<button id='changePhoto' onclick="setPhoto();">修改图片</button>

<div class="mui-content">
    <form class="mui-input-group">
        <div class="mui-input-row">
            <label>旧密码</label>
            <input id='oldpass' type="password" class="mui-input-clear mui-input" placeholder="请输入旧密码">
        </div>
        <div class="mui-input-row">
            <label>新密码</label>
            <input id='newpass' type="password" class="mui-input-clear mui-input" placeholder="请输入新密码">
        </div>
        <div class="mui-input-row">
            <label>新确认</label>
            <input id='newpass_confirm' type="password" class="mui-input-clear mui-input" placeholder="请确认新密码">
        </div>
    </form>
    <div class="mui-content-padded">
        <button id='commit' onclick="setPassword();" class="mui-btn mui-btn-block mui-btn-primary">修改密码</button>
    </div>
    <div class="mui-content-padded">
        <p id='result'></p>
    </div>
</div>

<div class="mui-content-padded">
    <p id='result'></p>
</div>

<p>{{.Username}}</p>
<p>email: {{.Email}}</p>

<script src="../js/md5.js"></script>
<script src="../js/protobuf.js"></script>
<!-- 内嵌的javascript代码 -->
<script>
    function setPhoto() {
        // 获取输入框内的值
        var file = document.getElementById('selector').files[0];
        if (!file) {
            console.log("请选择文件...");
            return
        }

        console.log(file);

        const data = {
            cmd: 0,
            username: "{{.Username}}",
            token: localStorage.getItem("Token"),
            type: "photo",
            filename: file.name,
        };

        protobuf.load("../proto/file.proto", function (err, root) {
            if (err) throw err;

            var pbreq = root.lookupType("logics.FileReq");
            if (pbreq.verify(data)) throw Error(errMsg);

            var reqmsg = pbreq.create(data);
            console.log(reqmsg);

            // Encode a message to an Uint8Array (browser) or Buffer (node)
            var buffer = pbreq.encode(reqmsg).finish();
            const url = '/api/presignedUrl';
            const options = { body: buffer, method: "POST" };

            // 发出http post请求, 等待响应
            fetch(url, options).then((response)=>{
                console.log(response);
                response.arrayBuffer().then((buffer)=>{
                    console.log(buffer);
                    var rspmsg = root.lookupType("logics.FileRsp").decode(new Uint8Array(buffer))
                    console.log(rspmsg);
                    document.getElementById('result').innerText = rspmsg.message;
                    if (0 == rspmsg.code) {
                        // 将文件上传到url
                        console.log(file);
                        uploadFile(file, rspmsg.url);
                    }
                })
            });
        });
    }


    function uploadFile(file, url) {
        fetch(url, {
            method: 'PUT',
            body: file
        }).then(() => {
            //通知到后台修改图片
            var fileSuffix = file.name.split('.').pop().toLowerCase();
            var data = {
                username: "{{.Username}}",
                photo: "{{.Username}}."+fileSuffix,
            };

            protobuf.load("../proto/user.proto", function (err, root) {
                if (err) throw err;

                var pbreq = root.lookupType("logics.UserSetPhotoReq");
                if (pbreq.verify(data)) throw Error(errMsg);

                var reqmsg = pbreq.create(data);
                console.log(reqmsg);

                // Encode a message to an Uint8Array (browser) or Buffer (node)
                var buffer = pbreq.encode(reqmsg).finish();
                const url = '/api/userSetPhoto';
                const options = { body: buffer, method: "POST" };

                // 发出http post请求, 等待响应
                fetch(url, options).then((response)=>{
                    response.arrayBuffer().then((buffer)=>{
                        var rspmsg = root.lookupType("logics.Status").decode(new Uint8Array(buffer));
                        console.log(rspmsg);
                        document.getElementById('result').innerText = rspmsg.message;
                        if (rspmsg.code == 0) {
                            var photo = document.getElementById('photo');
                            var reader = new FileReader();
                            reader.readAsDataURL(file);
                            reader.onload = function() {
                                // 将读取的结果显示在页面中
                                photo.src = reader.result;
                            }

                        }
                    })
                });
            });
        }).catch((e) => {
            console.error(e);
        });
    }

    async function setPassword() {
        // 获取输入框内的值

        var oldpassBox = document.getElementById('oldpass');
        var newpassBox = document.getElementById('newpass');
        var newpassConfirmBox = document.getElementById('newpass_confirm');

        var info = {
            username: "{{.Username}}",
            oldpass: oldpassBox.value,
            newpass: newpassBox.value,
        };

        //密码 由数字/字母/下划线组成 2-16位
        var passwordReg = /^(\w){2,16}$/;
        if (!passwordReg.test(info.oldpass)) {
            alert('密码只能由数字/字母/下划线组成(2-16位)。');
            return;
        }

        if (!passwordReg.test(info.newpass)) {
            alert('密码只能由数字/字母/下划线组成(2-16位)。');
            return;
        }

        if (info.oldpass == info.newpass) {
            alert('旧密码不能与新密码相同!');
            return;
        }

        var newpassConfirm = newpassConfirmBox.value;
        if (newpassConfirm != info.newpass) {
            alert('密码两次输入不一致');
            return;
        }

        info.oldpass = md5(info.oldpass);
        info.newpass = md5(info.newpass);
        console.log(info)

        const url = '/api/userSetPassword';
        const options = {
            headers: {
                "content-type": "application/json; charset=UTF-8"
            },
            // 将请求javascript object转换为JSON字符串
            body: JSON.stringify(info),
            method: "POST"
        }

        // 发出http post请求, 等待响应
        let rsp = await fetch(url, options)
        // 将响应作为JSON字符串反序列化为javascript object
        let rspjson = await rsp.json()
        console.log(rspjson)
        document.getElementById('result').innerText = rspjson.status.message;

        if (0 == rspjson.status.code) {
            localStorage.setItem("Token", rspjson.token);
            // window.location.href = "index.html";
        }
    }

</script>
</body>
</html>